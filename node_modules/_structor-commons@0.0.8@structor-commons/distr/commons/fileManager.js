"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ensureFilePath(e){return new Promise(function(r,t){_fsExtra2.default.ensureFile(e,function(e){e?t(e):r()})})}function ensureDirPath(e){return new Promise(function(r,t){_fsExtra2.default.ensureDir(e,function(e){e?t(e):r()})})}function readFile(e){return new Promise(function(r,t){_fsExtra2.default.readFile(e,{encoding:"utf8"},function(i,n){i?t("Can't read file: "+e+". Cause: "+i.message):r(n)})})}function writeFile(e,r,t){return new Promise(function(i,n){if(r||n("File data is undefined. File path: "+e),t===!0)try{r=(0,_utils.formatJs)(r)}catch(r){n(r.message+". File path: "+e)}_fsExtra2.default.writeFile(e,r,{encoding:"utf8"},function(e){e?n(e):i()})})}function writeBinaryFile(e,r){return new Promise(function(t,i){r||i("File data is undefined. File path: "+e),_fsExtra2.default.writeFile(e,r,{encoding:null},function(e){e?i(e):t()})})}function placeInPosition(e,r){return readFile(e).then(function(t){if(!t)throw Error("Cannot place content into file. Cause: file is empty. File path: "+e);var i=t.split(""),n=r.text.split(""),a=[r.position,0];return a=a.concat(n),Array.prototype.splice.apply(i,a),i.join("")}).then(function(t){return writeFile(e,t,r.format)})}function copyFiles(e){return e.reduce(function(e,r){return e.then(function(){return copyFile(r.srcFilePath,r.destFilePath)})},Promise.resolve())}function copyFilesNoError(e){return e.reduce(function(e,r){return e.then(function(){return copyFile(r.srcFilePath,r.destFilePath).catch(function(e){console.error(e)})})},Promise.resolve())}function copyFile(e,r){return new Promise(function(t,i){_fsExtra2.default.stat(e,function(n,a){n?i(n):a&&(a.isDirectory()?_fsExtra2.default.ensureDir(r,function(n){n?i(n):_fsExtra2.default.copy(e,r,function(e){e?i(e):t()})}):a.isFile()&&_fsExtra2.default.ensureFile(r,function(n){n?i(n):_fsExtra2.default.copy(e,r,function(e){e?i(e):t()})}))})})}function traverseDirTree(e,r){e&&(e.dirs&&e.dirs.length>0&&e.dirs.forEach(function(e){r("dir",e),traverseDirTree(e,r)}),e.files&&e.files.length>0&&e.files.forEach(function(e){r("file",e)}))}function isExisting(e){return new Promise(function(r,t){_fsExtra2.default.stat(e,function(i,n){i?t(i):n.isDirectory()||n.isFile()?r():t(e+" is not a file or a dir")})})}function findComponentFilePath(e){return new Promise(function(r,t){_fsExtra2.default.stat(e,function(i,n){if(i)t(i);else if(n.isDirectory()){var a=_path2.default.join(e,"index.js");_fsExtra2.default.stat(a,function(i,n){i?t(i):n.isFile()?r(a):t(e+" is not a file or a dir")})}else n.isFile()?r(e.endsWith(".js")&&e.endsWith(".jsx")?e:e+".js"):t(e+" is not a file or a dir")})})}function readDirectoryTree(e,r,t){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;_fsExtra2.default.lstat(r,function(n,a){n&&t(n);var o=0,s=0,u=function(r,n){var a=_path2.default.join(r,n).replace(/\\/g,"/");_fsExtra2.default.stat(a,function(r,u){if(r&&t(r),u&&u.isDirectory()){var f=e.dirNamePath?e.dirNamePath+"."+n:n,c={dirName:n,dirNamePath:f,dirPath:a,dirs:[],files:[]};e.dirs.push(c),readDirectoryTree(c,a,function(e){e&&t(e),++s==o&&t()},i)}else{var l=!i||_lodash2.default.includes(i,n);l&&e.files.push({fileName:n,filePath:a}),++s==o&&t()}})};a&&a.isDirectory()?_fsExtra2.default.readdir(r,function(e,i){e&&t(e),o=i.length,0===o&&t(),i.sort(function(e,r){return e>r?1:e<r?-1:0});for(var n=0,a=i.length;n<a;n++)u(r,i[n])}):t("Path: "+r+" is not a directory")})}function readDirectory(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return new Promise(function(t,i){var n={dirs:[],files:[]};readDirectoryTree(n,e,function(e){e?i(e):t(n)},r)})}function readDirectoryFiles(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return readDirectory(e,r).then(function(e){var r=[];return traverseDirTree(e,function(e,t){"file"===e&&r.push(t.filePath)}),{files:r}})}function readDirectoryFlat(e){return new Promise(function(r,t){_fsExtra2.default.lstat(e,function(i,n){i&&t(i);var a={files:[],dirs:[]},o=0;n&&n.isDirectory()?_fsExtra2.default.readdir(e,function(t,i){o=i.length,0===o&&r(a);for(var n=[],s=function(r,t){var o=_path2.default.join(e,i[r]).replace(/\\/g,"/"),s=i[r];n.push(new Promise(function(e,r){_fsExtra2.default.stat(o,function(t,i){t&&r(t),i.isDirectory()?a.dirs.push({name:s,path:o}):a.files.push({name:s,path:o}),e(a)})}))},u=0,f=i.length;u<f;u++)s(u,f);return Promise.all(n).then(function(){r(a)})}):t("path: "+e+" is not a directory")})})}function checkDirIsEmpty(e){return new Promise(function(r,t){_fsExtra2.default.stat(e,function(i,n){i?t("Can not read directory. "+i):n&&n.isDirectory()?_fsExtra2.default.readdir(e,function(i,n){var a=n.length;0===a?r():t(e+" is not empty")}):t(e+" is not a directory")})})}function readJson(e){return new Promise(function(r,t){_fsExtra2.default.readJson(e,function(e,i){e?t(e):r(i)})})}function writeJson(e,r){return ensureFilePath(e).then(function(){return new Promise(function(t,i){_fsExtra2.default.writeJson(e,r,function(e){e?i(e):t()})})})}function removeFile(e){return new Promise(function(r,t){_fsExtra2.default.remove(e,function(e){e?t(e):r()})})}function unpackTarGz(e,r){return new Promise(function(t,i){_fsExtra2.default.createReadStream(e).pipe(_zlib2.default.createGunzip()).on("error",function(e){i(e)}).pipe(_tarFs2.default.extract(r,{dmode:"0666",fmode:"0666"}).on("finish",function(){t()})).on("error",function(e){i(e)})})}function unpackTar(e,r){return new Promise(function(t,i){_fsExtra2.default.createReadStream(e).pipe(_tarFs2.default.extract(r,{dmode:"0666",fmode:"0666"}).on("finish",function(){t()})).on("error",function(e){i(e)})})}function repackTarGzOmitRootDir(e){return new Promise(function(r,t){var i=e+"_tmp",n=_tarStream2.default.pack(),a=_tarStream2.default.extract();a.on("entry",function(e,r,t){return e.name=e.name.substr(e.name.indexOf("/")+1),e.name.length>0?void r.pipe(n.entry(e,t)):(r.resume(),t())}),a.on("finish",function(){n.finalize(),r(i)}),a.on("error",function(e){t(e)}),_fsExtra2.default.createReadStream(e).pipe(_zlib2.default.createGunzip()).pipe(a);var o=_fsExtra2.default.createWriteStream(i);n.pipe(o)})}function packTarGz(e,r,t){return new Promise(function(i,n){var a=_fsExtra2.default.createWriteStream(r);_tarFs2.default.pack(e,{entries:t}).pipe(_zlib2.default.createGzip()).pipe(a).on("finish",function(){i()}).on("error",function(e){n(e)})})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.ensureFilePath=ensureFilePath,exports.ensureDirPath=ensureDirPath,exports.readFile=readFile,exports.writeFile=writeFile,exports.writeBinaryFile=writeBinaryFile,exports.placeInPosition=placeInPosition,exports.copyFiles=copyFiles,exports.copyFilesNoError=copyFilesNoError,exports.copyFile=copyFile,exports.traverseDirTree=traverseDirTree,exports.isExisting=isExisting,exports.findComponentFilePath=findComponentFilePath,exports.readDirectoryTree=readDirectoryTree,exports.readDirectory=readDirectory,exports.readDirectoryFiles=readDirectoryFiles,exports.readDirectoryFlat=readDirectoryFlat,exports.checkDirIsEmpty=checkDirIsEmpty,exports.readJson=readJson,exports.writeJson=writeJson,exports.removeFile=removeFile,exports.unpackTarGz=unpackTarGz,exports.unpackTar=unpackTar,exports.repackTarGzOmitRootDir=repackTarGzOmitRootDir,exports.packTarGz=packTarGz;var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_fsExtra=require("fs-extra"),_fsExtra2=_interopRequireDefault(_fsExtra),_path=require("path"),_path2=_interopRequireDefault(_path),_zlib=require("zlib"),_zlib2=_interopRequireDefault(_zlib),_tarFs=require("tar-fs"),_tarFs2=_interopRequireDefault(_tarFs),_tarStream=require("tar-stream"),_tarStream2=_interopRequireDefault(_tarStream),_utils=require("./utils.js");