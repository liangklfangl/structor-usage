"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function assignImport(e,n){var t=config.appDirPath(),o=void 0;if(e){var r=e.source,a=(e.member,void 0);r&&r.length>0&&(a=r.split("/"),a.length>0&&(o={},"."===a[0]&&a.length>1?(n?(o.importPath=_path2.default.join(n,r.substr(2)),o.absolutePath=_path2.default.join(t,o.importPath)):(o.importPath=r.substr(2),o.absolutePath=_path2.default.join(t,o.importPath)),"components"===a[1]?o.isComponent=!0:"containers"===a[1]?o.isContainer=!0:"modules"===a[1]&&(o.isModule=!0)):(n?(o.importPath=_path2.default.join(n,r),o.absolutePath=_path2.default.join(t,o.importPath)):(o.importPath=r,o.absolutePath=_path2.default.join(t,o.importPath)),"components"===a[0]?o.isComponent=!0:"containers"===a[0]?o.isContainer=!0:"modules"===a[0]?o.isModule=!0:a[0].startsWith(".")||(o.isLibMember=!0,o.importPath=n||r,delete o.absolutePath))))}return o}function reevaluateImports(e){return(0,_lodash.forOwn)(e,function(e,n){e.source=(0,_utils.repairPath)(e.source)}),e}function getIndexRefs(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t={components:{},modules:{}};return(0,_fileManager.readFile)(e).then(function(o){t.indexFilePath=e,t.indexSourceCode=o;var r=(0,_utils.parse)(o),a=(0,_astUtils.getImportsObject)(r),i=(0,_astUtils.getNamedExportObject)(r);return i?(a=reevaluateImports(a),(0,_lodash.forOwn)(i,function(o,r){if((0,_lodash.isObject)(o))console.warn("Components index can not include nested object references: ",r,e);else{var i=a[o];if(i){var u=assignImport(i,n.importPath);if(u){var s=(0,_lodash.pick)(u,["importPath","absolutePath"]);s.name=r,u.isComponent?t.components[r]=s:u.isContainer?(t.components[r]=s,s.isContainer=!0):u.isModule?t.modules[r]=s:u.isLibMember?(t.components[r]=s,s.isLibMember=!0):console.error("Invalid component definition: ",r,e)}else console.error("Components index includes wrong reference definition: ",r,e)}else console.error("Components index includes reference without import: ",r,e)}}),t):(console.error("Export definition was not found in ",e),t)})}function fulfillComponentDef(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=Object.assign({},e),o=t.isLibMember,r=t.absolutePath,a=void 0;return a=n&&n.name?_path2.default.join(config.componentDefaultsDirPath(),n.name,t.name+".json"):_path2.default.join(config.componentDefaultsDirPath(),t.name+".json"),(0,_fileManager.readJson)(a).then(function(e){if(!e||e.length<=0)throw Error("Defaults not found");e.forEach(function(e){e.variant=e.variant||"default"}),t.defaults=e}).catch(function(e){var o={type:t.name,variant:"default",children:[]};n&&n.name&&(o.namespace=n.name),t.defaults=[o]}).then(function(){if(!o&&r){var e=_path2.default.join(r,"index.js");return(0,_fileManager.isExisting)(e).then(function(){return(0,_fileManager.isExisting)(e)}).then(function(){if(t.absoluteIndexFilePath=e,t.isContainer){var n=_path2.default.join(r,"reducer.js");return(0,_fileManager.isExisting)(n)}}).then(function(){return t})}return t})}function fulfillHtmlComponents(){var e={},n=_path2.default.join(config.componentDefaultsDirPath(),"#html");return(0,_fileManager.readDirectoryFlat)(n).then(function(n){var t=Promise.resolve();if(n){var o=n.files;o&&o.length&&(o.sort(function(e,n){return e.name>n.name?1:e.name<n.name?-1:0}),o.forEach(function(n){t=t.then(function(){var t=_path2.default.basename(n.name,".json"),o={name:t};return(0,_fileManager.readJson)(n.path).then(function(e){if(!e||e.length<=0)throw Error("Defaults not found");o.defaults=e}).catch(function(e){var n={type:t,variant:"default",children:[]};o.defaults=[n]}).then(function(){e[t]=o})})}))}return t}).then(function(){return e})}function getComponentTree(){var e={},n=config.deskIndexFilePath(),t=config.deskReducersFilePath(),o=config.deskSagasFilePath();return(0,_fileManager.readFile)(t).then(function(n){return e.reducersFilePath=t,e.reducersSourceCode=n,(0,_fileManager.readFile)(o)}).then(function(t){return e.sagasFilePath=o,e.sagasSourceCode=t,getIndexRefs(n)}).then(function(n){e=Object.assign(e,n);var t=e,o=t.components,r=t.modules,a=Promise.resolve();return o&&!(0,_lodash.isEmpty)(o)&&(0,_lodash.forOwn)(o,function(e,n){a=a.then(function(){return fulfillComponentDef(e).then(function(e){o[n]=e}).catch(function(e){console.error("Invalid component structure: ",n),console.error(e),delete o[n]})})}),r&&!(0,_lodash.isEmpty)(r)&&(0,_lodash.forOwn)(r,function(e,n){e.absolutePath&&(a=a.then(function(){var t=_path2.default.join(e.absolutePath,"index.js");return getIndexRefs(t,e).then(function(n){var t=Promise.resolve(),o=n.components,r=n.indexFilePath,a=n.indexSourceCode;return o&&!(0,_lodash.isEmpty)(o)&&(e.components=o,e.indexSourceCode=a,e.indexFilePath=r,(0,_lodash.forOwn)(o,function(n,r){t=t.then(function(){return fulfillComponentDef(n,e).then(function(e){o[r]=e}).catch(function(e){console.error("Invalid component structure: ",r),console.error(e),delete o[r]})})})),t}).then(function(){var n=_path2.default.join(e.absolutePath,"reducer.js");return(0,_fileManager.readFile)(n).then(function(t){e.reducerFilePath=n,e.reducerImportPath=_path2.default.join(e.importPath,"reducer.js"),e.reducerSourceCode=t}).catch(function(e){})}).then(function(){var n=_path2.default.join(e.absolutePath,"sagas.js");return(0,_fileManager.readFile)(n).then(function(t){e.sagasFilePath=n,e.sagasSourceCode=t}).catch(function(e){})}).catch(function(e){console.error("Invalid module structure: ",n),console.error(e),delete r[n]})}))}),a.then(function(){return e})}).then(function(){return fulfillHtmlComponents().then(function(n){return e.htmlComponents=n,e})})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getComponentTree=getComponentTree;var _path=require("path"),_path2=_interopRequireDefault(_path),_lodash=require("lodash"),_configuration=require("../configuration.js"),config=_interopRequireWildcard(_configuration),_fileManager=require("../commons/fileManager.js"),_utils=require("../commons/utils.js"),_astUtils=require("../commons/astUtils.js");