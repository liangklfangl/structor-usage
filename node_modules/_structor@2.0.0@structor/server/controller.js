"use strict";function _interopRequireWildcard(r){if(r&&r.__esModule)return r;var e={};if(null!=r)for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o]);return e["default"]=r,e}function _interopRequireDefault(r){return r&&r.__esModule?r:{"default":r}}function printError(r,e){r&&console.log(r),console.error(e.message?e.message:e)}function callControllerMethod(r,e,o){var t=e.body.methodName,i=e.body.data||{};r[t]?r[t](i).then(function(r){void 0===r?o.send({data:null}):r.error?o.send({error:!0,errors:r.errors}):o.send({data:r})})["catch"](function(r){var e=r.message?r.message:r.toString();o.send({error:!0,errors:[e]})}):o.send({error:!0,errors:["Server does not have method: "+t]})}function initServer(r){var e=r.serverDir,o=r.projectDir,t=r.portNumber,i=r.debugMode,n=r.io;return serverDirPath=e,projectDirPath=o,config.init(e,o,i).then(function(r){r&&(server.app=(0,_express2["default"])(),server.app.use("/structor",_express2["default"]["static"](_path2["default"].join(serverDirPath,"static"))),server.appServer=_http2["default"].createServer(server.app),n&&(server.ioSocket=n(server.appServer),server.ioSocket.on("connection",function(r){server.ioSocketClient=r,server.ioSocketClient.emit("invitation","Hello from server.")})),server.appServer.listen(t,function(){r===config.READY&&(console.log("Structor has been started successfully."),console.log("\nOpen in the browser: http://localhost:"+t+"/structor\n"))}),r===config.READY&&initStructorController())})["catch"](function(r){printError("Error happened during server initialization:",r)})}function reinitServer(){return config.init(serverDirPath,projectDirPath).then(function(r){if(r!==config.READY)throw Error("Server reinitialization should not be provided in empty directory.");return initStructorController(),"OK"})}function initDownloadController(){server.app.post("/structor-project-download",_bodyParser2["default"].json({limit:"50mb"}),function(r,e){callControllerMethod(downloadController,r,e)}),downloadController.setProjectDirPath(projectDirPath),downloadController.setPostInstallationCallback(reinitServer)}function initStructorController(){server.app.post("/structor-invoke",_bodyParser2["default"].json({limit:"50mb"}),function(r,e){callControllerMethod(structorController,r,e)}),structorController.setServer(server)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.initServer=initServer;var _express=require("express"),_express2=_interopRequireDefault(_express),_http=require("http"),_http2=_interopRequireDefault(_http),_path=require("path"),_path2=_interopRequireDefault(_path),_bodyParser=require("body-parser"),_bodyParser2=_interopRequireDefault(_bodyParser),_configuration=require("./commons/configuration.js"),config=_interopRequireWildcard(_configuration),_controller=require("./structor/controller.js"),structorController=_interopRequireWildcard(_controller),_controller2=require("./download/controller.js"),downloadController=_interopRequireWildcard(_controller2),server={io:void 0,ioSocket:void 0,ioSocketClient:void 0,app:void 0,appServer:void 0,proxy:void 0},serverDirPath=void 0,projectDirPath=void 0;