"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=e[t]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function loopback(e){return _promise2["default"].resolve("Response: "+e.message)}function error(e){return _promise2["default"].reject("Response: "+e.message)}function setServer(e){serverRef=e,config.status()===config.READY&&(initServer(),initProxyServer())}function initServer(){serverRef&&(serverRef.app.use(middlewareCompilerManager.getDevMiddleware()),serverRef.app.use(middlewareCompilerManager.getHotMiddleware()),serverRef.app.use(middlewareCompilerManager.getBuilderMiddleware({callback:function(e){serverRef.ioSocketClient&&serverRef.ioSocketClient.emit("compiler.message",e)}})),serverRef.app.use((0,_expressUrlrewrite2["default"])("/structor-deskpage/*","/structor-desk/index.html")),serverRef.app.use("/structor-desk",_express2["default"]["static"](config.deskDirPath())))}function initProxyServer(){serverRef&&!proxy&&config.projectProxyURL()&&(proxy=_httpProxy2["default"].createProxyServer({}),proxy.on("error",function(e,r,t){var n="Proxy server error connecting to "+config.projectProxyURL()+r.url+" "+(e.message?e.message:e);t.writeHead(500,n),t.end(n),console.error(n)}),proxy.on("proxyReq",function(){var e=config.projectProxyURL().replace("http://","");return function(r,t,n,o){r.setHeader("X-Forwarded-Host",e)}}),serverRef.app.all("/*",function(e,r,t){var n=e.url;if(config.checkDeniedProxyURL(n))t("route");else{var o=config.projectProxyURL();o&&o.length>0?proxy.web(e,r,{target:o}):t("route")}}))}function getModel(){return storageManager.readProjectJsonModel()}function getConfig(){return _promise2["default"].resolve(config.asObject())}function getProjectStatus(){return _promise2["default"].resolve(config.status())}function setProxyURL(e){return config.rewriteProjectConfigOption("proxyURL",e.proxyURL).then(function(){initProxyServer()})}function getComponentsTree(){return indexManager.getComponentsTree()}function getComponentDefaults(e){return storageManager.readDefaults(e.componentName)}function getComponentNotes(e){return storageManager.readComponentDocument(e.componentName)}function getComponentSourceCode(e){return storageManager.readComponentSourceCode(e.filePath)}function writeComponentSourceCode(e){return storageManager.writeComponentSourceCode(e.filePath,e.sourceCode)}function saveProjectModel(e){return storageManager.writeProjectJsonModel(e.model)}function initUserCredentialsByToken(e){return clientManager.initUserCredentialsByToken(e.token)}function initUserCredentials(e){return clientManager.initUserCredentials(e.username,e.password)}function removeUserCredentials(e){return clientManager.removeAuthToken()}function getProjectsGallery(){return clientManager.getAllProjects()}function getAvailableGeneratorsList(){return clientManager.getAvailableGeneratorsList()}function getAvailableGeneratorGenerics(){return clientManager.getAvailableGeneratorGenerics()}function pregenerate(e){var r=e.generatorId,t=e.version,n=e.groupName,o=e.componentName,a=e.model;return generatorManager.initGeneratorData(n,o,a).then(function(e){return clientManager.invokePreGeneration(r,t,e)})}function generate(e){var r=e.generatorId,t=e.version,n=e.groupName,o=e.componentName,a=e.model,i=e.metadata;return generatorManager.initGeneratorData(n,o,a,i).then(function(e){return clientManager.invokeGeneration(r,t,e)})}function saveGenerated(e){var r=e.groupName,t=e.componentName,n=e.files,o=e.dependencies;return generatorManager.installDependencies(o).then(function(){return generatorManager.saveGenerated(r,t,n)})}function getGeneratorReadme(e){var r=e.userId,t=e.generatorId;return clientManager.getGeneratorReadmeText(r,t)}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.loopback=loopback,exports.error=error,exports.setServer=setServer,exports.getModel=getModel,exports.getConfig=getConfig,exports.getProjectStatus=getProjectStatus,exports.setProxyURL=setProxyURL,exports.getComponentsTree=getComponentsTree,exports.getComponentDefaults=getComponentDefaults,exports.getComponentNotes=getComponentNotes,exports.getComponentSourceCode=getComponentSourceCode,exports.writeComponentSourceCode=writeComponentSourceCode,exports.saveProjectModel=saveProjectModel,exports.initUserCredentialsByToken=initUserCredentialsByToken,exports.initUserCredentials=initUserCredentials,exports.removeUserCredentials=removeUserCredentials,exports.getProjectsGallery=getProjectsGallery,exports.getAvailableGeneratorsList=getAvailableGeneratorsList,exports.getAvailableGeneratorGenerics=getAvailableGeneratorGenerics,exports.pregenerate=pregenerate,exports.generate=generate,exports.saveGenerated=saveGenerated,exports.getGeneratorReadme=getGeneratorReadme;var _express=require("express"),_express2=_interopRequireDefault(_express),_expressUrlrewrite=require("express-urlrewrite"),_expressUrlrewrite2=_interopRequireDefault(_expressUrlrewrite),_httpProxy=require("http-proxy"),_httpProxy2=_interopRequireDefault(_httpProxy),_configuration=require("../commons/configuration.js"),config=_interopRequireWildcard(_configuration),_indexManager=require("../commons/indexManager.js"),indexManager=_interopRequireWildcard(_indexManager),_clientManager=require("../commons/clientManager.js"),clientManager=_interopRequireWildcard(_clientManager),_storageManager=require("./storageManager.js"),storageManager=_interopRequireWildcard(_storageManager),_middlewareCompilerManager=require("./middlewareCompilerManager.js"),middlewareCompilerManager=_interopRequireWildcard(_middlewareCompilerManager),_generatorManager=require("./generatorManager.js"),generatorManager=_interopRequireWildcard(_generatorManager),_exportManager=require("./exportManager.js"),exportManager=_interopRequireWildcard(_exportManager),serverRef=void 0,proxy=void 0;