"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function createPageDataObject(e,t){var r={model:e,pageName:e.pageName,pageTitle:e.pageTitle,pageMetaInfo:e.pageProps,bodyScript:e.pageScript,imports:[]},a=modelParser.getModelComponentMap(_lodash2["default"].extend(e,{type:e.pageName}));return t.groups&&_lodash2["default"].forOwn(t.groups,function(e,t){e.components&&e.components.length>0&&e.components.map(function(e){a[e.name]&&r.imports.push({name:e.name,source:e.source,member:e.member})})}),r}function createResourcesDataObject(e){var t={requires:[]};return e.requires&&e.requires.length>0&&e.requires.map(function(e){t.requires.push({source:e.source})}),t}function createProjectDataObject(e,t,r){var a={outputDirPath:t,indexFilePath:config.deskIndexFilePath(),pages:[]},o=createResourcesDataObject(r);if(!(e&&e.pages&&e.pages.length>0))throw Error("Project does not have pages.");return e.pages.forEach(function(e,t){var n=createPageDataObject(e,r);n.resources=o,a.pages.push(n)}),a=pathResolver.resolveFromProjectPerspective(a)}function doGeneration(e){var t=config.getProjectConfig();if(!_lodash2["default"].has(t,"conf.paths.exportDirPath"))return _promise2["default"].reject("Wrong project configuration. 'paths.exportDirPath' field is missing.");var r={pages:[]};return indexManager.initIndex().then(function(a){var o=createProjectDataObject(e,t.conf.paths.exportDirPath,a);return fileManager.readDirectoryFiles(config.templatesDirPath()).then(function(e){if(!e.files||e.files.length<=0)throw Error("Current project does not have a templates for export.");return e.files.reduce(function(e,t){return e.then(function(e){var r=e||[],a=_path2["default"].extname(t);return".tpl"===a?fileManager.readFile(t).then(function(e){return r.push({dirPath:_path2["default"].dirname(t),filePath:t,outputFileName:_path2["default"].basename(t,".tpl"),templateObj:_lodash2["default"].template(e)}),r}):r})["catch"](function(e){throw Error(e.message+". Broken export template file: "+t)})},_promise2["default"].resolve())}).then(function(e){return r.outputDirPath=o.outputDirPath,e.forEach(function(e){e.outputFileName.indexOf("{pagename}")>=0?o.pages.forEach(function(t,a){var n=e.outputFileName.replace("{pagename}",t.pageName);r.pages.push({pageOutputFilePath:_path2["default"].join(o.outputDirPath,n).replace(/\\/g,"/"),pageSourceCode:e.templateObj(t)})}):r.pages.push({pageOutputFilePath:_path2["default"].join(o.outputDirPath,e.outputFileName).replace(/\\/g,"/"),pageSourceCode:e.templateObj(o)})}),r})})}function commitGeneration(e){var t=_promise2["default"].resolve();return t=t.then(function(){return fileManager.removeFile(e.outputDirPath)}),e.pages.forEach(function(e,r){t=t.then(function(){return fileManager.ensureFilePath(e.pageOutputFilePath).then(function(){var t=_path2["default"].extname(e.pageOutputFilePath);return fileManager.writeFile(e.pageOutputFilePath,e.pageSourceCode,".js"===t)})})}),t}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.createPageDataObject=createPageDataObject,exports.createResourcesDataObject=createResourcesDataObject,exports.createProjectDataObject=createProjectDataObject,exports.doGeneration=doGeneration,exports.commitGeneration=commitGeneration;var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_path=require("path"),_path2=_interopRequireDefault(_path),_fileManager=require("../commons/fileManager.js"),fileManager=_interopRequireWildcard(_fileManager),_indexManager=require("../commons/indexManager.js"),indexManager=_interopRequireWildcard(_indexManager),_modelParser=require("../commons/modelParser.js"),modelParser=_interopRequireWildcard(_modelParser),_fileFormatter=require("../commons/fileFormatter.js"),formatter=_interopRequireWildcard(_fileFormatter),_configuration=require("../commons/configuration.js"),config=_interopRequireWildcard(_configuration),_pathResolver=require("./pathResolver.js"),pathResolver=_interopRequireWildcard(_pathResolver);