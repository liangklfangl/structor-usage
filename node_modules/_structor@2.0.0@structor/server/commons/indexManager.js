"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function findExportsNode(e){var r=null;return fileParser.traverse(e,function(e){"ExportDefaultDeclaration"===e.type&&(r=e.declaration)}),r}function findImports(e){var r={};return fileParser.traverse(e,function(e){"ImportDeclaration"===e.type&&!function(){var n=e.specifiers,t=e.source;n&&n.length>0&&t&&n.forEach(function(e){var n=e.type,o=e.local,i=t.value;"ImportDefaultSpecifier"===n&&o&&"Identifier"===o.type&&i?r[o.name]={source:i}:"ImportSpecifier"===n&&o&&"Identifier"===o.type&&i&&(r[o.name]={source:i,member:!0})})}()}),r}function appendToNode(e,r){var n=_esprima2["default"].parse("var c = {"+r+"}"),t=null;if(fileParser.traverse(n,function(e){"VariableDeclarator"===e.type&&"c"===e.id.name&&(t=e.init.properties[0])}),e.properties){var o=-1;e.properties.length>0&&(o=(0,_lodash.findIndex)(e.properties,function(e){return e.key&&"Identifier"===e.key.type&&e.key.name===t.key.name})),o>=0?e.properties[o]=t:e.properties.push(t)}}function memberExpressionToString(e,r){var n=r||"";return"MemberExpression"===e.type&&(n+=memberExpressionToString(e.object,n),n&&n.length>0?n+="."+e.property.name:n=e.property.name),n}function parseIndexFile(){return fileManager.readFile(config.deskIndexFilePath()).then(function(e){if(!e)throw Error("Index file is empty.");try{return fileParser.getFileAst(e)}catch(r){throw Error(r.message+". File path: "+config.deskIndexFilePath())}})}function getStructure(e){var r={imports:findImports(e),groups:{}},n=findExportsNode(e);if(n){var t=n.properties;t&&t.length>0&&t.forEach(function(e){var n=r.groups[e.key.name]={components:[]},t=e.value.properties;t&&t.length>0&&t.forEach(function(e){var t={name:e.key.name},o=r.imports[t.name];o&&(t.source=o.source,t.member=o.member),n.components.push(t)})})}return r}function resolveAbsoluteSourcePath(e){var r=e.groups,n=[];return r&&(0,_lodash.forOwn)(r,function(e,r){e.components&&e.components.length>0&&e.components.forEach(function(e){e.source&&n.push(fileManager.findComponentFilePath(_path2["default"].join(config.appDirPath(),e.source)).then(function(r){e.absoluteSource=r})["catch"](function(e){}))})}),_promise2["default"].all(n).then(function(){return e})}function getComponentsNamesFromTree(e){var r=[];return(0,_lodash.forOwn)(e,function(e,n){(0,_lodash.forOwn)(e,function(e,n){r.push(n)})}),r}function initIndex(){return parseIndexFile().then(function(e){return resolveAbsoluteSourcePath(getStructure(e))}).then(function(e){return e})}function getComponentsTree(){return initIndex().then(function(e){var r={};return e&&e.groups&&(0,_lodash.forOwn)(e.groups,function(e,n){r[n]={},e.components&&e.components.length>0&&e.components.forEach(function(e){r[n][e.name]={name:e.name,absoluteSource:e.absoluteSource}})}),r})}function getComponentsNames(){return getComponentsTree().then(function(e){return getComponentsNamesFromTree(e)})}function addComponent(e,r,n){return parseIndexFile().then(function(t){var o=findExportsNode(t);if(o){var i=null;fileParser.traverse(o,function(r){"Property"===r.type&&"Identifier"===r.key.type&&"ObjectExpression"===r.value.type&&r.key.name===e&&(i=r.value)}),i?appendToNode(i,r+': require("'+n+'")'):appendToNode(o,e+": {"+r+': require("'+n+'")}')}return _escodegen2["default"].generate(t)}).then(function(e){return fileManager.writeFile(config.deskIndexFilePath(),e,!0)}).then(function(){return initIndex()})}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.findExportsNode=findExportsNode,exports.findImports=findImports,exports.getStructure=getStructure,exports.initIndex=initIndex,exports.getComponentsTree=getComponentsTree,exports.getComponentsNames=getComponentsNames,exports.addComponent=addComponent;var _lodash=require("lodash"),_path=require("path"),_path2=_interopRequireDefault(_path),_esprima=require("esprima"),_esprima2=_interopRequireDefault(_esprima),_escodegen=require("escodegen"),_escodegen2=_interopRequireDefault(_escodegen),_fileManager=require("./fileManager.js"),fileManager=_interopRequireWildcard(_fileManager),_fileParser=require("./fileParser.js"),fileParser=_interopRequireWildcard(_fileParser),_configuration=require("./configuration.js"),config=_interopRequireWildcard(_configuration);