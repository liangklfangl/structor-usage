"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t["default"]=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function ensureFilePath(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].ensureFile(e,function(e){e?r(e):t()})})}function ensureDirPath(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].ensureDir(e,function(e){e?r(e):t()})})}function readFile(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].readFile(e,{encoding:"utf8"},function(i,n){i?r("Can't read file: "+e+". Cause: "+i.message):t(n)})})}function writeFile(e,t,r){return new _promise2["default"](function(i,n){if(t||n("File data is undefined. File path: "+e),r===!0)try{t=formatter.formatJsFile(t)}catch(a){n(a.message+". File path: "+e)}_fsExtra2["default"].writeFile(e,t,{encoding:"utf8"},function(e){e?n(e):i()})})}function writeBinaryFile(e,t){return new _promise2["default"](function(r,i){t||i("File data is undefined. File path: "+e),_fsExtra2["default"].writeFile(e,t,{encoding:null},function(e){e?i(e):r()})})}function placeInPosition(e,t){return readFile(e).then(function(r){if(!r)throw Error("Cannot place content into file. Cause: file is empty. File path: "+e);var i=r.split(""),n=t.text.split(""),a=[t.position,0];return a=a.concat(n),Array.prototype.splice.apply(i,a),i.join("")}).then(function(r){return writeFile(e,r,t.format)})}function copyFiles(e){return e.reduce(function(e,t){return e.then(function(){return copyFile(t.srcFilePath,t.destFilePath)})},_promise2["default"].resolve())}function copyFile(e,t){return new _promise2["default"](function(r,i){_fsExtra2["default"].stat(e,function(n,a){n?i(n):a&&(a.isDirectory()?_fsExtra2["default"].ensureDir(t,function(n){n?i(n):_fsExtra2["default"].copy(e,t,function(e){e?i(e):r()})}):a.isFile()&&_fsExtra2["default"].ensureFile(t,function(n){n?i(n):_fsExtra2["default"].copy(e,t,function(e){e?i(e):r()})}))})})}function traverseDirTree(e,t){e&&(e.dirs&&e.dirs.length>0&&e.dirs.forEach(function(e){t("dir",e),traverseDirTree(e,t)}),e.files&&e.files.length>0&&e.files.forEach(function(e){t("file",e)}))}function isExisting(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].stat(e,function(i,n){i?r(i):n.isDirectory()||n.isFile()?t():r(e+" is not a file or a dir")})})}function findComponentFilePath(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].stat(e,function(i,n){i?r(i):n.isDirectory()?!function(){var i=_path3["default"].join(e,"index.js");_fsExtra2["default"].stat(i,function(n,a){n?r(n):a.isFile()?t(i):r(e+" is not a file or a dir")})}():n.isFile()?t(e.endsWith(".js")&&e.endsWith(".jsx")?e:e+".js"):r(e+" is not a file or a dir")})})}function readDirectoryTree(e,t,r){var i=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];_fsExtra2["default"].lstat(t,function(n,a){n&&r(n);var o=0,u=0,f=function(t,n){var a=_path3["default"].join(t,n).replace(/\\/g,"/");_fsExtra2["default"].stat(a,function(t,f){if(t&&r(t),f&&f.isDirectory()){var s=e.dirNamePath?e.dirNamePath+"."+n:n,l={dirName:n,dirNamePath:s,dirPath:a,dirs:[],files:[]};e.dirs.push(l),readDirectoryTree(l,a,function(e){e&&r(e),++u==o&&r()},i)}else{var c=!i||_lodash2["default"].includes(i,n);c&&e.files.push({fileName:n,filePath:a}),++u==o&&r()}})};a&&a.isDirectory()?_fsExtra2["default"].readdir(t,function(e,i){e&&r(e),o=i.length,0===o&&r(),i.sort(function(e,t){return e>t?1:e<t?-1:0});for(var n=0,a=i.length;n<a;n++)f(t,i[n])}):r("Path: "+t+" is not a directory")})}function readDirectory(e){var t=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1];return new _promise2["default"](function(r,i){var n={dirs:[],files:[]};readDirectoryTree(n,e,function(e){e?i(e):r(n)},t)})}function readDirectoryFiles(e){var t=arguments.length<=1||void 0===arguments[1]?void 0:arguments[1];return readDirectory(e,t).then(function(e){var t=[];return traverseDirTree(e,function(e,r){"file"===e&&t.push(r.filePath)}),{files:t}})}function readDirectoryFlat(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].lstat(e,function(i,n){i&&r(i);var a={files:[]},o=0;n&&n.isDirectory()?_fsExtra2["default"].readdir(e,function(i,n){o=n.length,0===o&&t(a);for(var u=0,f=n.length;u<f;u++){var s=_path3["default"].join(e,n[u]).replace(/\\/g,"/");_fsExtra2["default"].stat(s,function(e,i,n){return function(u,f){u&&r(u),a.files.push({name:i,path:e,isDirectory:f.isDirectory()}),n===o-1&&t(a)}}(s,n[u],u))}}):r("path: "+e+" is not a directory")})})}function checkDirIsEmpty(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].stat(e,function(i,n){i?r("Can not read directory. "+i):n&&n.isDirectory()?_fsExtra2["default"].readdir(e,function(i,n){var a=n.length;0===a?t():r(e+" is not empty")}):r(e+" is not a directory")})})}function readJson(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].readJson(e,function(e,i){e?r(e):t(i)})})}function writeJson(e,t){return new _promise2["default"](function(r,i){_fsExtra2["default"].writeJson(e,t,function(e){e?i(e):r()})})}function removeFile(e){return new _promise2["default"](function(t,r){_fsExtra2["default"].remove(e,function(e){e?r(e):t()})})}function unpackTarGz(e,t){return new _promise2["default"](function(r,i){_fsExtra2["default"].createReadStream(e).pipe(_zlib2["default"].createGunzip()).pipe(_tarFs2["default"].extract(t,{dmode:"0666",fmode:"0666"}).on("finish",function(){r()})).on("error",function(e){i(e)})})}function unpackTar(e,t){return new _promise2["default"](function(r,i){_fsExtra2["default"].createReadStream(e).pipe(_tarFs2["default"].extract(t,{dmode:"0666",fmode:"0666"}).on("finish",function(){r()})).on("error",function(e){i(e)})})}function repackTarGzOmitRootDir(e){return new _promise2["default"](function(t,r){var i=e+"_tmp",n=_tarStream2["default"].pack(),a=_tarStream2["default"].extract();a.on("entry",function(e,t,r){return e.name=e.name.substr(e.name.indexOf("/")+1),e.name.length>0?void t.pipe(n.entry(e,r)):(t.resume(),r())}),a.on("finish",function(){n.finalize(),t(i)}),a.on("error",function(e){r(e)}),_fsExtra2["default"].createReadStream(e).pipe(_zlib2["default"].createGunzip()).pipe(a);var o=_fsExtra2["default"].createWriteStream(i);n.pipe(o)})}function packTarGz(e,t,r){return new _promise2["default"](function(i,n){var a=_fsExtra2["default"].createWriteStream(t);_tarFs2["default"].pack(e,{entries:r}).pipe(_zlib2["default"].createGzip()).pipe(a).on("finish",function(){i()}).on("error",function(e){n(e)})})}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.ensureFilePath=ensureFilePath,exports.ensureDirPath=ensureDirPath,exports.readFile=readFile,exports.writeFile=writeFile,exports.writeBinaryFile=writeBinaryFile,exports.placeInPosition=placeInPosition,exports.copyFiles=copyFiles,exports.copyFile=copyFile,exports.traverseDirTree=traverseDirTree,exports.isExisting=isExisting,exports.findComponentFilePath=findComponentFilePath,exports.readDirectoryTree=readDirectoryTree,exports.readDirectory=readDirectory,exports.readDirectoryFiles=readDirectoryFiles,exports.readDirectoryFlat=readDirectoryFlat,exports.checkDirIsEmpty=checkDirIsEmpty,exports.readJson=readJson,exports.writeJson=writeJson,exports.removeFile=removeFile,exports.unpackTarGz=unpackTarGz,exports.unpackTar=unpackTar,exports.repackTarGzOmitRootDir=repackTarGzOmitRootDir,exports.packTarGz=packTarGz;var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_fsExtra=require("fs-extra"),_fsExtra2=_interopRequireDefault(_fsExtra),_path2=require("path"),_path3=_interopRequireDefault(_path2),_zlib=require("zlib"),_zlib2=_interopRequireDefault(_zlib),_tarFs=require("tar-fs"),_tarFs2=_interopRequireDefault(_tarFs),_tarStream=require("tar-stream"),_tarStream2=_interopRequireDefault(_tarStream),_fileFormatter=require("./fileFormatter.js"),formatter=_interopRequireWildcard(_fileFormatter);