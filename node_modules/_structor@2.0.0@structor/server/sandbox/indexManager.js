"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function findExportsNode(e){var r=null;fileParser.traverse(e,function(e){"ExpressionStatement"===e.type&&"AssignmentExpression"===e.expression.type&&("Identifier"===e.expression.left.type&&"exports"===e.expression.left.name?r=e.expression.right:"MemberExpression"===e.expression.left.type&&"exports"===e.expression.left.property.name&&(r=e.expression.right))});var n=null;return"Identifier"===r.type&&(n=r.name,fileParser.traverse(e,function(e){"VariableDeclarator"===e.type&&e.id.name===n&&(r=e.init)})),r}function appendToNode(e,r){var n=_esprima2["default"].parse("var c = {"+r+"}"),t=null;if(fileParser.traverse(n,function(e){"VariableDeclarator"===e.type&&"c"===e.id.name&&(t=e.init.properties[0])}),e.properties){var o=-1;e.properties.length>0&&(o=_lodash2["default"].findIndex(e.properties,function(e){return e.key&&"Identifier"===e.key.type&&e.key.name===t.key.name})),o>=0?e.properties[o]=t:e.properties.push(t)}}function memberExpressionToString(e,r){var n=r||"";return"MemberExpression"===e.type&&(n+=memberExpressionToString(e.object,n),n&&n.length>0?n+="."+e.property.name:n=e.property.name),n}function parseIndexFile(){return fileManager.readFile(sandboxConfig.deskIndexFilePath()).then(function(e){if(!e)throw Error("Index file is empty.");try{return fileParser.getFileAst(e)}catch(r){throw Error(r.message+". File path: "+sandboxConfig.deskIndexFilePath())}})}function getStructure(e){var r={requires:[],groups:{}};fileParser.traverse(e,function(e){"ExpressionStatement"===e.type&&e.expression&&"CallExpression"===e.expression.type&&e.expression.callee&&"require"===e.expression.callee.name&&r.requires.push({source:e.expression.arguments[0].value})});var n=findExportsNode(e);if(n){var t=n.properties;t&&t.length>0&&t.forEach(function(e){var n=r.groups[e.key.name]={components:[]},t=e.value.properties;t&&t.length>0&&t.forEach(function(e){var r={name:e.key.name};fileParser.traverse(e,function(e){"CallExpression"===e.type&&e.callee&&"require"===e.callee.name&&e.arguments&&e.arguments.length>0&&(r.source=e.arguments[0].value)}),"MemberExpression"===e.value.type&&(r.member=memberExpressionToString(e.value)),n.components.push(r)})})}return r}function resolveAbsoluteSourcePath(e){var r=e.requires;r&&r.length>0&&_lodash2["default"].forEach(r,function(e){e.source&&0===e.source.indexOf("../../")&&(e.absoluteSource=_path2["default"].resolve(_path2["default"].dirname(sandboxConfig.deskIndexFilePath()),e.source).replace(/\\/g,"/"))});var n=e.groups;return n&&_lodash2["default"].forOwn(n,function(e,r){e.components&&e.components.length>0&&e.components.forEach(function(e){e.source&&0===e.source.indexOf("../../")&&(e.absoluteSource=_path2["default"].resolve(_path2["default"].dirname(sandboxConfig.deskIndexFilePath()),e.source).replace(/\\/g,"/"))})}),e}function getComponentsNamesFromTree(e){var r=[];return _lodash2["default"].forOwn(e,function(e,n){_lodash2["default"].forOwn(e,function(e,n){r.push(n)})}),r}function initIndex(){return parseIndexFile().then(function(e){var r=getStructure(e);return r=resolveAbsoluteSourcePath(r)})}function getComponentsTree(){return initIndex().then(function(e){var r={};return e&&e.groups&&_lodash2["default"].forOwn(e.groups,function(e,n){r[n]={},e.components&&e.components.length>0&&e.components.forEach(function(e){r[n][e.name]={name:e.name,absoluteSource:e.absoluteSource}})}),r})}function getComponentsNames(){return getComponentsTree().then(function(e){return getComponentsNamesFromTree(e)})}function addComponent(e,r,n){return parseIndexFile().then(function(t){var o=findExportsNode(t);if(o){var i=null;fileParser.traverse(o,function(r){"Property"===r.type&&"Identifier"===r.key.type&&"ObjectExpression"===r.value.type&&r.key.name===e&&(i=r.value)}),i?appendToNode(i,r+': require("'+n+'")'):appendToNode(o,e+": {"+r+': require("'+n+'")}')}return _escodegen2["default"].generate(t)}).then(function(e){return fileManager.writeFile(sandboxConfig.deskIndexFilePath(),e,!0)}).then(function(){return initIndex()})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.initIndex=initIndex,exports.getComponentsTree=getComponentsTree,exports.getComponentsNames=getComponentsNames,exports.addComponent=addComponent;var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_path=require("path"),_path2=_interopRequireDefault(_path),_esprima=require("esprima"),_esprima2=_interopRequireDefault(_esprima),_escodegen=require("escodegen"),_escodegen2=_interopRequireDefault(_escodegen),_fileManager=require("../commons/fileManager.js"),fileManager=_interopRequireWildcard(_fileManager),_fileParser=require("../commons/fileParser.js"),fileParser=_interopRequireWildcard(_fileParser),_configuration=require("./configuration.js"),sandboxConfig=_interopRequireWildcard(_configuration);