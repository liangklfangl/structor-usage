"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n["default"]=e,n}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function repairPath(e){return"."!==e.substr(0,1)&&(e="./"+e),e}function initGeneratorData(e,n,t,r){return sandboxConfig.init(_path2["default"].join(config.sandboxDirPath(),"work").replace(/\\/g,"/")).then(function(){return sandboxIndexManager.initIndex()}).then(function(i){var a=[],o=sandboxConfig.getProjectConfig(),u={};return(0,_lodash.forOwn)(o.conf.files,function(e,n){a.push(fileManager.readFile(e).then(function(e){u[n]=e}))}),_promise2["default"].all(a).then(function(){return o.conf.sources=u,{groupName:e,componentName:n,model:t,metadata:r,project:o,index:i}})})}function installDependencies(e){if(e){var n=function(){var n=config.getProjectConfig();if(!(0,_lodash.has)(n,"conf.paths.assetsDirPath"))return{v:_promise2["default"].reject("Wrong project configuration. 'assetsDirPath' field is missing.")};if(!(0,_lodash.has)(n,"conf.files.assetsIndexFilePath"))return{v:_promise2["default"].reject("Wrong project configuration. 'assetsIndexFilePath' field is missing.")};var t=e.packages;if(t&&t.length>0){var r=function(){var e=_promise2["default"].resolve(),r="";return t.forEach(function(n){e=e.then(function(){return npmUtils.getPackageAbsolutePath(n.name,config.projectDir()).then(function(e){if(!e){var t=n.version&&n.version.trim().length>0?"@"+n.version.trim():"";r+=n.name+t+" "}})})}),e=e.then(function(){if(r=r.substr(0,r.length-1),r&&r.length>0)return npmUtils.installPackages(r,config.projectDir())}),t.forEach(function(t){var r=t.copy;r&&r.length>0&&!function(){var i=void 0;e=e.then(function(){return npmUtils.getPackageAbsolutePath(t.name,config.projectDir()).then(function(e){if(!e)throw Error("Package "+t.name+" was not installed properly.");i=e})}),r.forEach(function(t){e=e.then(function(){var e=_path2["default"].join(i,t.from).replace(/\\/g,"/"),r=_path2["default"].join(n.conf.paths.assetsDirPath,t.to).replace(/\\/g,"/");return fileManager.copyFile(e,r)})})}()}),{v:{v:e}}}();if("object"===("undefined"==typeof r?"undefined":(0,_typeof3["default"])(r)))return r.v}}();if("object"===("undefined"==typeof n?"undefined":(0,_typeof3["default"])(n)))return n.v}return _promise2["default"].resolve()}function saveGenerated(e){var n=[],t=void 0;return e.forEach(function(e){e.isComponent&&(t=e.outputFilePath),n.push(fileManager.ensureFilePath(e.outputFilePath).then(function(){return fileManager.writeFile(e.outputFilePath,e.sourceCode,!1)}))}),_promise2["default"].all(n).then(function(){return fileManager.readFile(sandboxConfig.deskIndexTemplatePath())}).then(function(e){if(t){var n=sandboxConfig.deskSourceDirPath(),r=_path2["default"].relative(n,t).replace(/\\/g,"/"),i=(0,_lodash.template)(e);return fileManager.writeFile(_path2["default"].join(sandboxConfig.deskSourceDirPath(),"index.js").replace(/\\/g,"/"),i({componentRelativePath:r}),!1)}})}Object.defineProperty(exports,"__esModule",{value:!0});var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.initGeneratorData=initGeneratorData,exports.installDependencies=installDependencies,exports.saveGenerated=saveGenerated;var _lodash=require("lodash"),_path=require("path"),_path2=_interopRequireDefault(_path),_fileManager=require("../commons/fileManager.js"),fileManager=_interopRequireWildcard(_fileManager),_configuration=require("../commons/configuration.js"),config=_interopRequireWildcard(_configuration),_configuration2=require("./configuration.js"),sandboxConfig=_interopRequireWildcard(_configuration2),_indexManager=require("./indexManager.js"),sandboxIndexManager=_interopRequireWildcard(_indexManager),_npmUtils=require("../commons/npmUtils.js"),npmUtils=_interopRequireWildcard(_npmUtils);