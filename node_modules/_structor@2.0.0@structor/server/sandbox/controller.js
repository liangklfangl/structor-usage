"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function loopback(e){return _promise2["default"].resolve("Response: "+e.message)}function error(e){return _promise2["default"].reject("Response: "+e.message)}function setServer(e){serverRef=e,serverRef&&!function(){var e=_path2["default"].join(config.sandboxDirPath(),"work",".structor","desk").replace(/\\/g,"/");serverRef.app.use("/structor-sandbox-preview",_express2["default"]["static"](e));var r=_multer2["default"].diskStorage({destination:function(r,n,o){o(null,_path2["default"].join(e,"assets","img").replace(/\\/g,"/"))},filename:function(e,r,n){n(null,"screenshot.png")}}),n=(0,_multer2["default"])({storage:r});serverRef.app.post("/structor-sandbox-screenshot",n.single("screenshot"),function(e,r,n){r.status(204).end()})}()}function makeWorkingDirectory(e){var r=e.generatorId,n=e.userId;return storageManager.makeWorkingCopy(r,n)}function removeWorkingDirectory(e){return storageManager.deleteWorkingCopy()}function compileWorkingDesk(e){return projectCompiler.compileWorkingCopy()}function getGeneratorSamples(e){return clientManager.getGeneratorSamples()}function sandboxPrepare(e){return clientManager.sandboxPrepare(e.generatorId,e.version)}function sandboxReadFiles(e){return clientManager.sandboxReadFiles(e.sampleId)}function sandboxWriteFiles(e){return clientManager.sandboxWriteFiles(e.sampleId,e.filesObject)}function sandboxGenerate(e){var r=e.sampleId,n=e.metadata,o=e.model,t="TestGroup",a="TestComponent";return generatorManager.initGeneratorData(t,a,o,n).then(function(e){return clientManager.sandboxProcess(r,e)}).then(function(e){var r=e.files,n=a+".json";return r.forEach(function(r){if(r.outputFileName===n)try{e.defaultModel=JSON.parse(r.sourceCode)}catch(o){console.error("Sandbox default model source code parsing: "+o)}}),(!e.defaultModel||!(0,_lodash.isArray)(e.defaultModel)||e.defaultModel.length<=0)&&(e.defaultModel=[{type:a}]),e})}function saveSandboxGenerated(e){var r=e.files,n=e.dependencies;return generatorManager.installDependencies(n).then(function(){return generatorManager.saveGenerated(r)})}function sandboxPublish(e){return clientManager.sandboxPublish(e.sampleId,e.generatorKey,e.forceClone)}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise);exports.loopback=loopback,exports.error=error,exports.setServer=setServer,exports.makeWorkingDirectory=makeWorkingDirectory,exports.removeWorkingDirectory=removeWorkingDirectory,exports.compileWorkingDesk=compileWorkingDesk,exports.getGeneratorSamples=getGeneratorSamples,exports.sandboxPrepare=sandboxPrepare,exports.sandboxReadFiles=sandboxReadFiles,exports.sandboxWriteFiles=sandboxWriteFiles,exports.sandboxGenerate=sandboxGenerate,exports.saveSandboxGenerated=saveSandboxGenerated,exports.sandboxPublish=sandboxPublish;var _path=require("path"),_path2=_interopRequireDefault(_path),_express=require("express"),_express2=_interopRequireDefault(_express),_multer=require("multer"),_multer2=_interopRequireDefault(_multer),_lodash=require("lodash"),_clientManager=require("../commons/clientManager.js"),clientManager=_interopRequireWildcard(_clientManager),_storageManager=require("./storageManager.js"),storageManager=_interopRequireWildcard(_storageManager),_projectCompiler=require("./projectCompiler.js"),projectCompiler=_interopRequireWildcard(_projectCompiler),_generatorManager=require("./generatorManager.js"),generatorManager=_interopRequireWildcard(_generatorManager),_configuration=require("../commons/configuration.js"),config=_interopRequireWildcard(_configuration),serverRef=void 0;