"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n.default=e,n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function appendToNode(e,n){var r=_esprima2.default.parse("var c = {"+n+"}"),t=null;if((0,_utils.traverse)(r,function(e){"VariableDeclarator"===e.type&&"c"===e.id.name&&(t=e.init.properties[0])}),e.properties){var o=-1;e.properties.length>0&&(o=(0,_lodash.findIndex)(e.properties,function(e){return e.key&&"Identifier"===e.key.type&&e.key.name===t.key.name})),o>=0?e.properties[o]=t:e.properties.push(t)}}function memberExpressionToString(e,n){var r=n||"";return"MemberExpression"===e.type&&(r+=memberExpressionToString(e.object,r),r&&r.length>0?r+="."+e.property.name:r=e.property.name),r}function parseIndexFile(e){return fileManager.readFile(e).then(function(n){if(!n)throw Error("Index file is empty.");try{return(0,_utils.parse)(n)}catch(n){throw Error(n.message+". File path: "+e)}})}function getStructure(e){var n={imports:(0,_astUtils.findImports)(e),groups:{}},r=(0,_astUtils.findExportsNode)(e);if(r){var t=r.properties;t&&t.length>0&&t.forEach(function(e){var r=n.groups[e.key.name]={components:[]},t=e.value.properties;t&&t.length>0&&t.forEach(function(t){var o={group:e.key.name,name:t.key.name},i=n.imports[o.name];i&&(o.source=i.source,o.member=i.member),r.components.push(o)})})}return n}function resolveAbsoluteSourcePath(e,n){var r=e.groups,t=[];return r&&(0,_lodash.forOwn)(r,function(e,r){e.components&&e.components.length>0&&e.components.forEach(function(e){e.source&&t.push(fileManager.findComponentFilePath(_path2.default.join(n,e.source)).then(function(n){n&&(e.absoluteSource=n.replace(/\\/g,"/"))}).catch(function(e){}))})}),Promise.all(t).then(function(){return e})}function getComponentsNamesFromTree(e){var n=[];return(0,_lodash.forOwn)(e,function(e,r){(0,_lodash.forOwn)(e,function(e,r){n.push(r)})}),n}function initIndex(){return parseIndexFile(config.deskIndexFilePath()).then(function(e){return resolveAbsoluteSourcePath(getStructure(e),config.appDirPath())}).then(function(e){return e})}function getComponentsTree(){return initIndex().then(function(e){var n={};return e&&e.groups&&(0,_lodash.forOwn)(e.groups,function(e,r){n[r]={},e.components&&e.components.length>0&&e.components.forEach(function(e){n[r][e.name]={name:e.name,absoluteSource:e.absoluteSource}})}),n})}function getComponentsNames(e,n){return getComponentsTree(e,n).then(function(e){return getComponentsNamesFromTree(e)})}function addComponent(e,n,r,t,o){return parseIndexFile(t).then(function(t){var o=(0,_astUtils.findExportsNode)(t);if(o){var i=null;(0,_utils.traverse)(o,function(n){"Property"===n.type&&"Identifier"===n.key.type&&"ObjectExpression"===n.value.type&&n.key.name===e&&(i=n.value)}),i?appendToNode(i,n+': require("'+r+'")'):appendToNode(o,e+": {"+n+': require("'+r+'")}')}return _escodegen2.default.generate(t)}).then(function(e){return fileManager.writeFile(t,e,!0)}).then(function(){return initIndex(t,o)})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getStructure=getStructure,exports.initIndex=initIndex,exports.getComponentsTree=getComponentsTree,exports.getComponentsNames=getComponentsNames,exports.addComponent=addComponent;var _lodash=require("lodash"),_path=require("path"),_path2=_interopRequireDefault(_path),_esprima=require("esprima"),_esprima2=_interopRequireDefault(_esprima),_escodegen=require("escodegen"),_escodegen2=_interopRequireDefault(_escodegen),_fileManager=require("../commons/fileManager.js"),fileManager=_interopRequireWildcard(_fileManager),_utils=require("../commons/utils.js"),_astUtils=require("../commons/astUtils.js"),_configuration=require("../configuration.js"),config=_interopRequireWildcard(_configuration);