"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function fixText(e){if(e)return e.replace(/'/g,"\\'")}function isMetaRef(e){return void 0!==e&&_lodash2.default.isString(e)&&0===e.indexOf("$")}function getMetaRefName(e){if(e){var t=e.split("_");if(t.length>0)return t[0].substr(1)}}function getMetaVarObject(e){if(e){var t={},r=e.split("_");if(r.length>0){var n=r[r.length-1],a=n.split("$");a.length>0?(t.ext=a[0],t.extRef=a[1]):t.ext=n}return t.varName=r[0],t}}function getMetaModel(e){var t=[];return(0,_utils.traverseModelWithResult)(e,function(e,t){var r={type:e.type,text:e.text};return e.children&&e.children.length>0&&(r.children=[]),r.props=e.props||{},t.push(r),r.children},t),t}function enrichStateToPropVars(e){var t=new Map,r=e.component.stateToProps;if(r&&r.length>0)try{var n=(0,_utils.parse)("const "+r+"=meta;",{tolerant:!0,range:!1,comment:!1});(0,_utils.traverse)(n,function(e){"Property"===e.type&&"Identifier"===e.value.type&&t.set(e.value.name,!0)})}catch(e){throw Error('Meta info "stateToProps" parsing: '+(e.message||e))}return e.propVars=t,e}function enrichRefs(e){var t=new Map;return e.render&&!_lodash2.default.isEmpty(e.render)&&(0,_utils.traverseModel)(e.render,function(e){e.props&&e.props.ref&&t.set(e.props.ref,!0)}),e.refs=t,e}function initActionArgumentObj(e,t,r){var n={},a=r.substr(t.range[0],t.range[1]-t.range[0]);if(a&&a.length>0){var s=a.split(".");if(0===s[0].indexOf("$")){var o=s[0].substr(1);if(e.propVars.has(o))n.propVar=o;else{if(!e.refs.has(o))throw Error('Could not find a reference for action argument: "$'+o+'"');n.ref=o}}else n.argumentName=s[0];n.argumentRestText=s.slice(1).join(".")}return n}function initActionObj(e,t,r,n){var a=void 0;if("ExpressionStatement"===t.type&&t.expression&&"CallExpression"===t.expression.type&&t.expression.callee&&t.expression.callee.name?a=t.expression:"CallExpression"===t.type&&t.callee&&t.callee.name&&(a=t),a){var s=a,o=s.callee.name,i=s.arguments,l=getMetaVarObject(o);if(!l)throw Error("Action name can not be parsed: "+o);var p=l.varName,u=l.ext;if(!r.has(p)&&l){var c={label:u||"none",actionName:p,arguments:[],constantName:_lodash2.default.snakeCase(p).toUpperCase()};i&&i.length>0&&i.forEach(function(t){c.arguments.push(initActionArgumentObj(e,t,n.rawText))}),r.set(p,c)}n.actions.set(p,r.get(p))}}function enrichHandlers(e){var t=new Map,r=new Map,n=e.component.handlers;return n&&!_lodash2.default.isEmpty(n)&&_lodash2.default.forOwn(n,function(n,a){try{var s={methodName:a,actions:new Map,parameters:[],rawText:n};t.set(a,s);var o=(0,_utils.parse)(n,{tolerant:!0,range:!0,comment:!1});(0,_utils.traverse)(o,function(t){"ArrowFunctionExpression"===t.type&&(t.params&&t.params.length>0&&t.params.forEach(function(e){s.parameters.push(e.name)}),(0,_utils.traverse)(t.body,function(t){initActionObj(e,t,r,s)}))})}catch(e){throw Error('Meta info "handlers.'+a+'" parsing: '+(e.message||e))}}),e.handlerFuncs=t,e.actions=r,e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.fixText=fixText,exports.isMetaRef=isMetaRef,exports.getMetaRefName=getMetaRefName,exports.getMetaVarObject=getMetaVarObject,exports.getMetaModel=getMetaModel,exports.enrichStateToPropVars=enrichStateToPropVars,exports.enrichRefs=enrichRefs,exports.enrichHandlers=enrichHandlers;var _lodash=require("lodash"),_lodash2=_interopRequireDefault(_lodash),_utils=require("../commons/utils.js");